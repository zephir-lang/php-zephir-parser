version: 1.3.5-{build}

environment:
  matrix:

    - PHP_VERSION: 7.0
      VC_VERSION: 14
      BUILD_TYPE: "Win32"
      VCVARSALL: "%VS120COMNTOOLS%/../../VC/vcvarsall.bat"
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013

    # - PHP_VERSION: 7.0
    #   VC_VERSION: 14
    #   BUILD_TYPE: "nts-Win32"
    #   VCVARSALL: "%VS120COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013

    # - PHP_VERSION: 7.1
    #   VC_VERSION: 14
    #   BUILD_TYPE: "Win32"
    #   VCVARSALL: "%VS120COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013

    # - PHP_VERSION: 7.1
    #   VC_VERSION: 14
    #   BUILD_TYPE: "nts-Win32"
    #   VCVARSALL: "%VS120COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013

    # - PHP_VERSION: 7.2
    #   VC_VERSION: 15
    #   BUILD_TYPE: "Win32"
    #   VCVARSALL: "%VS140COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015

    # - PHP_VERSION: 7.2
    #   VC_VERSION: 15
    #   BUILD_TYPE: "nts-Win32"
    #   VCVARSALL: "%VS140COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015

    # - PHP_VERSION: 7.3
    #   VC_VERSION: 15
    #   BUILD_TYPE: Win32
    #   VCVARSALL: "%VS140COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015

    # - PHP_VERSION: 7.3
    #   VC_VERSION: 15
    #   BUILD_TYPE: nts-Win32
    #   VCVARSALL: "%VS140COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015

    # - PHP_VERSION: 7.4
    #   VC_VERSION: 15
    #   BUILD_TYPE: Win32
    #   VCVARSALL: "%VS140COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015

    # - PHP_VERSION: 7.4
    #   VC_VERSION: 15
    #   BUILD_TYPE: nts-Win32
    #   VCVARSALL: "%VS140COMNTOOLS%/../../VC/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015

    # - PHP_VERSION: 8.0
    #   VC_VERSION: 16
    #   BUILD_TYPE: Win32
    #   VCVARSALL: "C:/Program Files (x86)/Microsoft Visual Studio/2019/Community/VC/Auxiliary/Build/vcvarsall.bat"
    #   APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019

    - PHP_VERSION: 8.0
      VC_VERSION: 16
      BUILD_TYPE: nts-Win32
      VCVARSALL: "C:/Program Files (x86)/Microsoft Visual Studio/2019/Community/VC/Auxiliary/Build/vcvarsall.bat"
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019

  PHP_SDK_VERSION: 2.1.9
  # PHP_AVM: https://raw.githubusercontent.com/sergeyklay/php-appveyor/master/php-appveyor.psm1
  PHP_AVM: https://raw.githubusercontent.com/AlexNDRmac/php-appveyor/fix-for-php8/php-appveyor.psm1

  TEST_PHP_EXECUTABLE: C:\php\php.exe
  NO_INTERACTION: 1
  REPORT_EXIT_STATUS: 1

matrix:
  fast_finish: true

cache:
  - 'C:\Downloads -> .appveyor.yml'

clone_depth: 1
clone_folder: C:\Projects\php-zephir-parser

platform:
  - x86
  - x64

branches:
  only:
    - master
    - development
    - windows-builds-php8

init:
  - ps: $DebugPreference = 'SilentlyContinue' # Continue

install:
  - ps: (new-object Net.WebClient).DownloadString($Env:PHP_AVM) | iex

  - ps: InstallPhpSdk     $Env:PHP_SDK_VERSION $Env:VC_VERSION $Env:PLATFORM
  - ps: InstallPhp        $Env:PHP_VERSION $Env:BUILD_TYPE $Env:VC_VERSION $Env:PLATFORM
  - ps: InstallPhpDevPack $Env:PHP_VERSION $Env:BUILD_TYPE $Env:VC_VERSION $Env:PLATFORM

  - ps: Import-Module .\.ci\AppVeyor.psm1
  - ps: AppendSessionPath
  - ps: TuneUpPhp

build_script:
  - if NOT "%VCVARSALL%" == "" call "%VCVARSALL%" %PLATFORM%
  - ps: InitializeBuildVars
  - phpsdk_setvars
  - cmd /c .ci\build-win32.bat
  - phpize
  - cmd: 'configure --with-prefix=C:\php --with-php-build=C:\php-devpack --disable-all --enable-zephir-parser=shared'
  - cmd: nmake 2> compile-errors.log 1> compile.log
  - ps: InitializeReleaseVars

test_script:
  - ps: >-
      EnablePhpExtension `
        -Name          zephir_parser `
        -PrintableName "Zephir Parser" `
        -ExtPath       $Env:RELEASE_PATH

after_test:
  - ps: >-
      PrepareReleasePackage `
        -PhpVersion     $Env:PHP_VERSION `
        -BuildType      $Env:BUILD_TYPE `
        -Platform       $Env:PLATFORM `
        -ConverMdToHtml $true `
        -ReleaseFiles   "${Env:RELEASE_PATH}\php_zephir_parser.dll",`
                        "${Env:APPVEYOR_BUILD_FOLDER}\LICENSE",`
                        "${Env:APPVEYOR_BUILD_FOLDER}\CREDITS",`
                        "${Env:APPVEYOR_BUILD_FOLDER}\VERSION",`
                        "${Env:APPVEYOR_BUILD_FOLDER}\NO_WARRANTY"

artifacts:
  - path: '.\$(RELEASE_ZIPBALL).zip'
    type: zip
    name: ZephirParser

on_failure:
  - ps: >-
      if (Test-Path -Path "${Env:APPVEYOR_BUILD_FOLDER}\compile-errors.log") {
        Get-Content -Path "${Env:APPVEYOR_BUILD_FOLDER}\compile-errors.log"
      }
      if (Test-Path -Path "${Env:APPVEYOR_BUILD_FOLDER}\compile.log") {
        Get-Content -Path "${Env:APPVEYOR_BUILD_FOLDER}\compile.log"
      }
